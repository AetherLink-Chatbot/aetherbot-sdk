<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatKit Playground - AetherBot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      overflow: hidden;
      height: 100vh;
      background: #fafafa;
    }

    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 320px;
      background: white;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .sidebar-header p {
      font-size: 14px;
      color: #6b7280;
    }

    .sidebar-content {
      padding: 24px;
      flex: 1;
    }

    .control-section {
      margin-bottom: 28px;
    }

    .control-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .control-input,
    .control-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      color: #111827;
      background: white;
      transition: all 0.2s;
    }

    .control-input:focus,
    .control-select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .control-input::placeholder {
      color: #9ca3af;
    }

    .color-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .color-input {
      width: 48px;
      height: 40px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      cursor: pointer;
    }

    .color-input::-webkit-color-swatch-wrapper {
      padding: 4px;
    }

    .color-input::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: #6366f1;
      color: white;
    }

    .btn-primary:hover {
      background: #4f46e5;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      margin-top: 8px;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    /* Chat Panel Styles */
    .chat-panel {
      flex: 1;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .chat-header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header h2 {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .mode-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #dbeafe;
      color: #1e40af;
    }

    .chat-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-height: 0; /* Important for flex children */
      display: flex;
      flex-direction: column;
    }
    .preview-stage {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    .preview-launcher {
      position: relative;
      height: 120px;
      border-top: 1px dashed #e5e7eb;
      background: rgba(255,255,255,0.6);
    }

    /* Loading State */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      flex-direction: column;
      gap: 16px;
      color: #6b7280;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toggle Switch */
    .toggle-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle.active {
      background: #6366f1;
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle.active::after {
      transform: translateX(20px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.open {
        transform: translateX(0);
      }
    }

    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #1e40af;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ChatKit Playground</h1>
        <p>Configure and test your AetherBot widget</p>
      </div>

      <div class="sidebar-content">
        <!-- Display Mode Section -->
        <div class="control-section">
          <div class="control-section-title">Display Mode</div>
          
          <div class="control-group">
            <label class="control-label">Widget Mode</label>
            <select id="mode-select" class="control-select">
              <option value="inline">Inline (Embedded)</option>
              <option value="overlay">Overlay (Floating)</option>
            </select>
          </div>

          <div class="control-group" id="position-group">
            <label class="control-label">Position (Overlay Only)</label>
            <select id="position-select" class="control-select">
              <option value="bottom-right">Bottom Right</option>
              <option value="bottom-left">Bottom Left</option>
              <option value="top-right">Top Right</option>
              <option value="top-left">Top Left</option>
            </select>
          </div>
        </div>

        <!-- Appearance Section -->
        <div class="control-section">
          <div class="control-section-title">Appearance</div>
          
          <div class="control-group">
            <label class="control-label">Display Name</label>
            <input type="text" id="display-name" class="control-input" placeholder="Arthur NEWS" value="Arthur NEWS">
          </div>

          <div class="control-group">
            <label class="control-label">Organization Name</label>
            <input type="text" id="org-name" class="control-input" placeholder="Droidor" value="Droidor">
          </div>

          <div class="control-group">
            <label class="control-label">Text Color</label>
            <div class="color-input-wrapper">
              <input type="color" id="color-text" class="color-input" value="#ffffff">
              <input type="text" id="color-text-hex" class="control-input" value="#ffffff">
            </div>
          </div>

          <div class="control-group">
            <label class="control-label">Background Color</label>
            <div class="color-input-wrapper">
              <input type="color" id="color-bg" class="color-input" value="#0f172a">
              <input type="text" id="color-bg-hex" class="control-input" value="#0f172a">
            </div>
          </div>

          <div class="control-group">
            <label class="control-label">Accent Color</label>
            <div class="color-input-wrapper">
              <input type="color" id="color-accent" class="color-input" value="#CF9FFF">
              <input type="text" id="color-accent-hex" class="control-input" value="#CF9FFF">
            </div>
          </div>

          <div class="control-group">
            <label class="control-label">AI Message Background</label>
            <div class="color-input-wrapper">
              <input type="color" id="color-ai-bg" class="color-input" value="#5D3FD3">
              <input type="text" id="color-ai-bg-hex" class="control-input" value="#5D3FD3">
            </div>
          </div>
        </div>

        <!-- Behavior Section -->
        <div class="control-section">
          <div class="control-section-title">Behavior</div>
          
          <div class="control-group">
            <label class="control-label">Chat History Mode</label>
            <select id="history-mode" class="control-select">
              <option value="history">Load History</option>
              <option value="always-new">Always New Chat</option>
              <option value="show-history">Show History</option>
            </select>
          </div>

          <div class="control-group">
            <label class="control-label">Welcome Message</label>
            <input type="text" id="welcome-msg" class="control-input" placeholder="Ready to assist you" value="Ready to assist you">
          </div>
        </div>

        <!-- Actions -->
        <button class="btn btn-primary" onclick="applyConfig()">Apply Configuration</button>
        <button class="btn btn-secondary" onclick="resetWidget()">Reset Widget</button>

        <div class="info-box" style="margin-top: 20px;">
          <strong>💡 Tip:</strong> In inline mode, the chat interface fills the right panel. In overlay mode, it appears as a floating widget.
        </div>
      </div>
    </aside>

    <!-- Chat Panel -->
    <main class="chat-panel">
      <div class="chat-header">
        <h2>Chat Preview</h2>
        <span class="mode-badge" id="mode-indicator">Inline Mode</span>
      </div>
      <div class="chat-container" id="chat-container">
        <div id="widget-stage" class="preview-stage">
          <div class="loading-state">
            <div class="spinner"></div>
            <p>Initializing widget...</p>
          </div>
        </div>
        <div id="launcher-stage" class="preview-launcher"></div>
      </div>
    </main>
  </div>

  <!-- AetherBot SDK -->
  <script>window.process = { env: { NODE_ENV: "production" } };</script>
  <script src="../dist/aetherbot-sdk.umd.js"></script>
  
  <script>
    const AVATAR_ID = 'e2c12fe6-1958-4320-b358-b3e78b65beff';
    const API_BASE = 'https://api.aetherbot.dev';

    let currentWidget = null;
    let avatarImageData = null;

    // Fetch avatar image
    fetch(`${API_BASE}/public/avatars-chat/${AVATAR_ID}/image`)
      .then((res) => (res.ok ? res.json() : null))
      .then((json) => {
        avatarImageData = json && json.avatar_image ? json.avatar_image : null;
        initWidget();
      })
      .catch(() => {
        avatarImageData = null;
        initWidget();
      });

    // Sync color inputs
    ['text', 'bg', 'accent', 'ai-bg'].forEach(type => {
      const colorInput = document.getElementById(`color-${type}`);
      const hexInput = document.getElementById(`color-${type}-hex`);
      
      colorInput.addEventListener('input', (e) => {
        hexInput.value = e.target.value;
      });
      
      hexInput.addEventListener('input', (e) => {
        colorInput.value = e.target.value;
      });
    });

    // Toggle position visibility based on mode
    document.getElementById('mode-select').addEventListener('change', (e) => {
      const positionGroup = document.getElementById('position-group');
      positionGroup.style.opacity = e.target.value === 'overlay' ? '1' : '0.5';
      positionGroup.style.pointerEvents = e.target.value === 'overlay' ? 'auto' : 'none';
    });

    function getConfig() {
      const mode = document.getElementById('mode-select').value;
      const position = document.getElementById('position-select').value;
      const displayName = document.getElementById('display-name').value;
      const orgName = document.getElementById('org-name').value;
      const historyMode = document.getElementById('history-mode').value;
      const welcomeMsg = document.getElementById('welcome-msg').value;

      const config = {
        avatarId: AVATAR_ID,
        externalUserId: 'playground-user',
        externalUserName: 'Playground User',
        displayName: displayName || 'Arthur NEWS',
        organizationName: orgName || 'Droidor',
        avatarImage: avatarImageData,
        chatHistoryMode: historyMode,
        welcomeMessage: welcomeMsg,
        mode: mode,
        theme: {
          text: document.getElementById('color-text-hex').value,
          background: document.getElementById('color-bg-hex').value,
          secondary: document.getElementById('color-accent-hex').value,
          aiMessageBg: document.getElementById('color-ai-bg-hex').value,
          bannerText: '#000000'
        },
        strings: {
          launcherTitle: "Let's Chat, Your Way",
          launcherSubtitle: 'This chatbot adapts to your style of conversation.',
          bannerTagline: 'Every conversation matters.',
          inputPlaceholder: 'Type message...',
          thinkingLabel: 'Thinking…',
        }
      };

      if (mode === 'inline') {
        config.container = '#widget-stage';
        config.launcherContainer = '#launcher-stage';
      } else {
        config.position = position;
        config.autoOpenMode = 'manual';
      }

      return config;
    }

    function initWidget() {
      if (currentWidget) {
        try {
          currentWidget.destroy();
        } catch (e) {
          console.log('Widget destroy error:', e);
        }
        currentWidget = null;
      }

      const config = getConfig();
      const mode = config.mode;

      console.log('Creating widget with config:', config);

      // Update mode indicator
      document.getElementById('mode-indicator').textContent = 
        mode === 'inline' ? 'Inline Mode' : 'Overlay Mode';

      // Clear containers for inline mode
      if (mode === 'inline') {
        const stage = document.getElementById('widget-stage');
        const launcherStage = document.getElementById('launcher-stage');
        if (stage) stage.innerHTML = '';
        if (launcherStage) launcherStage.innerHTML = '';
      }

      try {
        currentWidget = window.AetherbotWidget.create(config);
        console.log('Widget created successfully');
      } catch (error) {
        console.error('Error creating widget:', error);
        if (mode === 'inline') {
          container.innerHTML = `
            <div class="loading-state">
              <p style="color: #dc2626;">Error: ${error.message}</p>
              <p style="font-size: 12px; margin-top: 8px;">Check console for details</p>
            </div>
          `;
        }
      }
    }

    function applyConfig() {
      initWidget();
    }

    function resetWidget() {
      if (currentWidget) {
        currentWidget.resetConversation?.();
      }
    }
  </script>
</body>
</html>
